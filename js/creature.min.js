var window_w=$(window).width(),window_h=$(window).height(),speed_factor=0.2,creatures={},timers=[];function get_random_color(){for(var b="0123456789ABCDEF".split(""),a="#",c=0;6>c;c++)a+=b[Math.round(15*Math.random())];return a}function rand_id(b){var a=Math.floor(1E3*Math.random()+0);return 0<$("#hunter").length?rand_id(b):b+a}
function mark_oldest(b){var a=0,c="";$("."+b).each(function(){$(this).removeClass("oldest");var b=creatures[$(this).attr("id")];a=parseInt(b.age)>=a?b.age:a;c=b.age>a?$(this).attr("id"):c});$("#"+c).addClass("oldest");return c}
function create_item(b,a,c,e,d,f,h,g,l,k,n,q,t,u,v,p,r){p=Math.floor(100*Math.random()+0);u=["hunter","prey"][50<p?1:0];var w=Math.floor(50*Math.random()+0),s=Math.floor(50*Math.random()+10),A=Math.floor(Math.random()*window_w+0),B=Math.floor(Math.random()*window_h+0),C=Math.floor(100*Math.random()+10),D=Math.floor(100*Math.random()+0),E=Math.floor(10*Math.random()+1),F=Math.floor(100*Math.random()+0),G=Math.floor(20*Math.random()+0),z=Math.floor(100*Math.random()+0);Math.random();var m=Math.floor(100*
Math.random()+0);p=Math.floor(100*Math.random()+0);r=Math.floor(100*Math.random()+0);var z=50<z?"m":"f",H=get_random_color();b="undefined"===typeof b?u:b;a="undefined"===typeof a?w:a;c="undefined"===typeof c?s:c;e="undefined"===typeof e?A:e;d="undefined"===typeof d?B:d;f="food"==b?"#2AB811":"undefined"===typeof f?H:f;h="undefined"===typeof h?b:h;g="undefined"===typeof g?C:g;l="undefined"===typeof l?D:l;q="undefined"===typeof q?E:q;k="undefined"===typeof k?F:k;n="undefined"===typeof n?G:n;t="undefined"===
typeof t?z:t;u=0;v="undefined"===typeof v?m:v;p="undefined"===typeof p?ran_sex_desire:p;r="undefined"===typeof r?ran_sex_threshold:r;border_radius="hunter"==b?3:10;m=rand_id(b);w=q;s=$("#canvas").svg("get");"hunter"==b?s.rect(e,d,20,20,{fill:f,id:m,"class":"org "+h}):"prey"==b?s.circle(e,d,10,{fill:f,id:m,"class":"org "+h}):"food"==b&&s.circle(e,d,5,{fill:f,id:m,"class":"org "+h});creatures[m]={x:e,y:d,width:10,height:10,r:10,fill:f,mode:"sleep",id:m,age:0,type:b,color:f,sex_desire:p,sex_threshold:r,
store:u,store_using_threshold:v,gender:t,danger_distance:n,linger_rate:k,threshold:l,speed:a,eyesightfactor:c,"class":"org "+h,energy:g,danger_time:q,danger_time_long:w};creature_start(m);return m}
function creature_start(b){var a=creatures[b].type;"prey"!=a&&"hunter"!=a||keep_going(a,b);$("#"+b).click(function(){var a=creatures[b],a="<ul><li>Age: "+a.age+"</li><li>Speed: "+a.speed+"</li><li>Danger distance: "+a.danger_distance+"</li><li>Linger rate: "+a.linger_rate+"</li><li>Threshold: "+a.threshold+"</li><li>Eyesightfactor: "+a.eyesightfactor+"</li><li>Energy: "+a.energy+"</li><li>Danger time: "+a.danger_time+"</li><li>Danger time long: "+a.danger_time_long+"</li><li>Mode: "+a.mode+"</li><li>Sex desire: "+
a.sex_desire+"</li><li>Sex threshold: "+a.sex_threshold+"</li><li>Store: "+a.store+"</li><li>Store using threshold: "+a.store_using_threshold+"</li></ul>";$("#oldest").html(a)})}
function keep_going(b,a){var c=creatures[a];if(energy_control(a))if("hunter"==b){var e=tag(a,".prey","catch");creatures[a].mode="hunt";mode_color(a)}else"prey"==b&&(check_predator(a,"hunter"),"danger"==c.mode||0<c.danger_time?e=tag(a,".hunter","run"):0==c.danger_time&&(creatures[a].mode="hunt",mode_color(a),e=tag(a,".food","catch")));else if(sex_threshold=c.sex_threshold,sex_desire=c.sex_desire,sex_desire>sex_threshold)"hunter"==b?(e=tag(a,".hunter","catch"),creatures[a].mode="sex",mode_color(a)):
"prey"==b&&(check_predator(a,"hunter"),"danger"==c.mode||0<c.danger_time?e=tag(a,".hunter","run"):0==c.danger_time&&(creatures[a].mode="sex",mode_color(a),e=tag(a,".prey","catch")));else if(creatures[a].mode="sleep",mode_color(a),e=1E3,"prey"==b&&(check_predator(a,"hunter"),"danger"==c.mode||0<c.danger_time))e=tag(a,".hunter","run");timers["keep_going"+a]=setTimeout("keep_going('"+b+"','"+a+"')",e)}
function check_predator(b,a){var c=creatures[b];$("."+a).each(function(){get_saw(b,$(this).attr("id"))&&(new_position=get_position(b,$(this).attr("id"),"run"),$("#"+b),new_position.distance<=c.width*c.danger_distance?(creatures[b].mode="danger",mode_color(b),creatures[b].danger_time=c.danger_time_long):(creatures[b].mode="sleep",mode_color(b)))})}
function kill_slowly(){$(".org").each(function(){var b=creatures[$(this).attr("id")];energy_change(b.id,-1);$(this);if("sleep"==b.mode&&0<b.store&&b.store>b.store_using_threshold){var a=parseInt(b.store)-1;b.store=a;a=parseInt(b.energy)+1;b.energy=a}a=parseInt(b.age)+1;b.age=a;var a=b.danger_time,c=parseInt(b.sex_desire);100>c&&(b.sex_desire=c+1);0<a&&(b.danger_time=a-1);creatures[$(this).attr("id")]=b});setTimeout("kill_slowly()",1E3)}function mode_color(b){}
function energy_control(b){var a=creatures[b];b=parseInt(a.energy);var c=parseInt(a.store),e=parseInt(a.threshold),a=parseInt(a.store_using_threshold);if(b+c>e+a)return!1;if(b+c<e+a&&0<b)return!0}
function energy_change(b,a){var c=creatures[b];"sleep"==c.mode?0<c.store&&c.store>c.store_using_threshold?(c=parseInt(c.store)+parseInt(a),creatures[b].store=c):(c=parseInt(c.energy)+parseInt(a),creatures[b].energy=c,0>=c&&(delete creatures[b],c=$("#"+b),c.remove())):(c=parseInt(c.energy)+parseInt(a),creatures[b].energy=c,0>=c&&(delete creatures[b],c=$("#"+b),c.remove()))}
function go(b,a,c){var e=creatures[b],d=$("#"+b);parseInt(e.store/100);a>=window_w+20?a=-19.98:-20>a&&(a=window_w-0.02);c>=window_h+20?c=-19.98:-20>c&&(c=window_h-0.02);"hunter"==e.type?(d.attr("x",a),d.attr("y",c)):(d.attr("cx",a),d.attr("cy",c));creatures[b].x=a;creatures[b].y=c}function get_atts(b){b=creatures[b];return{x:parseFloat(b.x),y:parseFloat(b.y),w:parseFloat(b.width),h:parseFloat(b.height)}}
function get_position(b,a,c){var e=creatures[b],d=get_atts(b);b=d.x;d=d.y;e=e.speed;if("imaginary"==a){a=Math.floor(Math.random()*window_w+0);var f=Math.floor(Math.random()*window_h+0);a=b-a}else{him_o=$("#"+a);if(0>=him_o.length)return!1;a=get_atts(a);f=a.y;a=b-a.x}var f=d-f,h=Math.abs(a),g=Math.abs(f),l=Math.sqrt(Math.pow(a,2)+Math.pow(f,2)),k="catch"==c?1:-1,n=h/Math.sqrt(Math.pow(h,2)+Math.pow(g,2));c=n*k;k*=n*g/h;0<a?h<window_w/2&&(c*=-1):h>window_w/2&&(c*=-1);0<f?g<window_h/2&&(k*=-1):g>window_h/
2&&(k*=-1);return{x:c*e*speed_factor+b,y:k*e*speed_factor+d,distance:l}}function get_saw(b,a){var c=creatures[b],e=get_atts(b),d=get_atts(a),f=e.w,h=e.h,g=e.x-d.x,d=e.y-d.y,g=Math.abs(g),d=Math.abs(d),e=window_w-g,l=window_h-d,d=l<d?l:d,c=c.eyesightfactor*(f+h)/5,f=Math.sqrt(Math.pow(e<g?e:g,2)+Math.pow(d,2));return c>f?!0:!1}
function seeing(b,a,c){for(var e=a,d=0,f=[],h=0,g=0;g<e.length;g++)a=e[g],0==a.indexOf(".")?$(a).each(function(){$(this).attr("id")!==b&&get_saw(b,$(this).attr("id"))&&(new_position=get_position(b,$(this).attr("id"),c),f[d]={x:new_position.x,y:new_position.y,distance:new_position.distance,weight:0,element:$(this).attr("id")},h+=new_position.distance,d++)}):-1==a.indexOf(".")&&get_saw(b,a)&&(new_position=get_position(b,e[g],c),f[d]={x:new_position.x,y:new_position.y,distance:new_position.distance,
weight:0,element:e[g]},h+=new_position.distance,d++);return 0<d?{items:f,total_distance:h}:!1}function patrol(b){}function rand_choose(b,a){return 50<Math.floor(100*Math.random()+0)?b:a}
function cross_two(b,a){var c=creatures[b],e=creatures[a],d=parseInt(c.energy)-10;creatures[b].energy=d;d=parseInt(e.energy)-10;creatures[a].energy=d;var d=get_atts(b),e=d.x,d=d.y,f=$(".hunter").size()+$(".prey").size(),f=animal_size-f;if("hunter"==c.type&&$(".hunter").size()>=animal_size/3||"prey"==c.type&&$(".prey").size()>=2*animal_size/3)f=0;0<f&&(type=creatures[rand_choose(b,a)].type,speed=creatures[rand_choose(b,a)].speed,eyesightfactor=creatures[rand_choose(b,a)].eyesightfactor,x=e,y=d,color=
creatures[rand_choose(b,a)].color,family=creatures[rand_choose(b,a)].family,energy=100,threshold=creatures[rand_choose(b,a)].threshold,linger_rate=creatures[rand_choose(b,a)].linger_rate,danger_distance=creatures[rand_choose(b,a)].danger_distance,danger_time=creatures[rand_choose(b,a)].danger_time,gender=creatures[rand_choose(b,a)].gender,store=0,store_using_threshold=creatures[rand_choose(b,a)].store_using_threshold,sex_desire=creatures[rand_choose(b,a)].sex_desire,sex_threshold=creatures[rand_choose(b,
a)].sex_threshold,create_item(type,speed,eyesightfactor,x,y,color,family,energy,threshold,linger_rate,danger_distance,danger_time,gender,store,store_using_threshold,sex_desire,sex_threshold))}
function touch(b,a,c){var e=creatures[b],d=creatures[a],f=e.type,h=d.type,g=get_atts(a),l=g.h,g=Math.sqrt(Math.pow(g.w,2)+Math.pow(l,2));c<=g&&("hunter"==f&&"prey"==h||"prey"==f&&"food"==h?(c=parseInt(e.energy)+parseInt(d.energy/2),100<c?(creatures[b].energy=100,creatures[b].store=c-100):creatures[b].energy=c,creatures[b].mode="sleep",mode_color(b),$("#"+a).remove()):f==h&&(creatures[b].sex_desire=0,creatures[a].sex_desire=0,cross_two(b,a),creatures[b].mode="sleep",mode_color(b),mode_color(a),creatures[a].mode=
"sleep"))}
function tag(b,a,c){var e=creatures[b];from_string=a;a=a.split(",");if(c=seeing(b,a,c)){a=c.items;total_distance=c.total_distance;for(var d=c=posy=posx=0;d<a.length;d++)a[d].weight=total_distance/a[d].distance,c+=a[d].weight,touch(b,a[d].element,a[d].distance);for(d=0;d<a.length;d++)if(percent=a[d].weight/c,percent>e.linger_rate/100){posx=a[d].x;posy=a[d].y;break}else posx+=percent*a[d].x,posy+=percent*a[d].y;go(b,posx,posy);b=50}else creatures[b].mode="sleep",mode_color(b),b=1E3;return b};
